# RAG/baseline/features/cot.py
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain_core.prompts.few_shot import FewShotPromptTemplate
from langchain_core.prompts import PromptTemplate
from langchain_core.example_selectors import SemanticSimilarityExampleSelector
from langchain_community.vectorstores import FAISS # Use for example_selector

from config import OPENAI_API_KEY, LANGSMITH_TRACING_ENABLED, LANGCHAIN_PROJECT

# LangSmith 설정 (build_user_query_prompt_chain에서 LLM 생성 시 콜백 전달)
CALLBACKS_COT = []
if LANGSMITH_TRACING_ENABLED:
    from langchain.callbacks.tracers.langchain import LangChainTracer
    TRACER_COT = LangChainTracer(project_name=f"{LANGCHAIN_PROJECT}-CoT")
    CALLBACKS_COT = [TRACER_COT]

examples = [
        { 
            "question": "종서 이식 후 발아가 안 됨. 발아율 50% 정도. 종서 썩음.",
            "answer": """
    ### 1단계: 질문 의도 분석
    - 질문의 핵심은 이식 후 발아가 제대로 이루어지지 않고, 발아율이 낮으며, 종서가 썩는 문제에 대한 것입니다..
    - 이는 병해충 또는 생리장해에 관한 질문으로 분류됩니다.
    - 질문에서 구체적인 작물 이름이 명시되지 않았습니다. 따라서, 정확한 진단을 위해 어떤 작물에 대한 문제인지 추가 정보가 필요합니다.
    - 작물명이 명확하지 않으므로 일반적인 분석을 진행합니다.

    ### 추가 정보 요청
    - "종서 이식 후 발아 문제가 발생한 작물의 이름을 알려주실 수 있나요? 예를 들어, 감자, 고구마, 배추 등 중 어느 것인지 알려주시면 더 정확한 진단이 가능합니다."

    ### 2단계: 정보 탐색 및 근거 확인
    - 작물의 이름을 받지 못했기 때문에, 구체적인 진단과 방제법을 제공하기 어렵습니다.
    - 일반적으로 종자 썩음은 곰팡이나 박테리아 감염, 부적절한 저장 조건, 과습 등 다양한 원인에 의해 발생할 수 있습니다.
    - 이식 과정 중 과도한 습도나 통풍이 부족하면 이러한 현상이 발생할 수 있습니다.
    - 또한 종서가 병에 걸리기 쉬운 환경이라면 발아율이 낮아지며 썩을 확률이 높아집니다.

    ### 3단계: 논리적 정리 및 응답 생성
    🩺진단소견:
    종서 썩음과 낮은 발아율은 종종 곰팡이나 박테리아 감염, 저장 중의 습도 관리 불량, 이식 시 과습 등 여러 요인에 의해 발생할 수 있습니다.
    정확한 원인 분석을 위해서는 해당 작물의 종류와 재배 환경에 대한 추가 정보가 필요합니다.

    🌿방제법:
     일반적으로 종자 썩음을 방지하기 위해선 종자를 건조하고 통풍이 잘 되는 곳에 보관하고, 이식 전에 적절한 소독 처리를 하는 것이 중요합니다. 
     또한, 이식 시 토양의 습도를 적절히 조절하여 과습을 방지해야 합니다.

     ※ 추가 정보를 제공받지 못한 상태에서는 보다 구체적인 진단과 조치 방법을 제공하기 어렵습니다. 
        작물의 종류에 따라 상세한 조치 방법이 달라질 수 있으므로, 해당 작물의 이름을 알려주시면 더 정확한 안내가 가능합니다.
    """
        },
        {
            "question": "당근 잎에 검은 반점이 생기는데 무슨 병인가요?",
            "answer": """
    ### 1단계: 질문 의도 분석
    - 질문의 의도는 당근 잎에 나타나는 검은 반점의 원인과 관련된 식물 질병을 알아보는 것입니다.
    - 질문 유형은 병해충에 관한 질문입니다.
    - 질문에서는 당근이라는 작물에 대해 명확하게 언급되었습니다.
    - 시스템에서 제공하는 작물 리스트에 당근은 포함되지 않습니다.
    - 제공하는 작물 리스트는 다음과 같습니다:
        - 상추, 배추, 깻잎, 시금치, 감자, 고구마, 마늘, 양파, 토마토, 고추

    ### 2단계: 정보 탐색 및 근거 확인
    - 당근은 시스템에서 제공하는 작물이 아니므로, 문서에서 정보를 찾을 수 없습니다.

    ### 3단계: 논리적 정리 및 응답 생성
    🙏 안내드립니다:  
    본 시스템에서는 [상추], [배추], [깻잎], [시금치], [감자], [고구마], [마늘], [양파], [토마토], [고추]에 대한 정보만 제공하고 있습니다.  
    **당근**에 대한 정보는 제공되지 않으니, 관련 전문 기관이나 다른 자료를 참고해 주세요.
    """
        },
        {
            "question": "유재석이 누구야?",
            "answer": """
    ### 1단계: 질문 의도 분석
    - 질문의 의도는 유재석이라는 인물에 대한 정보를 요청하는 것입니다.
    - 이 질문은 농업과 관련된 주제가 아니며, 시스템이 제공하는 주제와 무관한 질문입니다.

    ### 2단계: 정보 탐색 및 근거 확인
    - 유재석은 유명한 한국의 방송인이지만, 이 시스템은 농업에 관한 정보만을 제공합니다.
    - 따라서, 유재석에 대한 정보는 이 시스템의 데이터 베이스에서 찾을 수 없습니다.

    ### 3단계: 논리적 정리 및 응답 생성
    🙏 안내드립니다:  
    본 시스템은 농업 관련 정보만을 제공하고 있습니다. 
    **유재석**에 대한 정보는 이 시스템의 범위를 벗어나므로, 관련 정보는 다른 시스템을 통해 확인하시기 바랍니다.
    """
        },
        {
            "question": "고구마를 심을 때 가장 좋은 시기는 언제인가요?",
            "answer": """
    ### 1단계: 질문 의도 분석
    - 질문의 의도는 고구마를 심는 가장 적절한 시기에 대한 정보를 요청하는 것입니다.
    - 질문 유형은 일반적인 농작물 재배법에 관한 질문입니다.
    - 질문에서는 고구마라는 작물에 대해 명확하게 언급되었습니다.
    - 고구마는 시스템에서 제공하는 작물 리스트에 포함되어 있습니다.

    ### 2단계: 정보 탐색 및 근거 확인
    - 참고 문서에서 고구마의 아주심기 적기에 대한 정보를 확인할 수 있습니다.
    - 문서에 따르면, 남부지방에서는 5월 상순, 중북부지방에서는 5월 중순부터 심는 것이 일반적입니다.
    - 아주심기 한계기는 남부지방에서는 7월 상순까지, 중북부지방에서는 6월 말까지입니다.

    ### 3단계: 논리적 정리 및 응답 생성
    📢 안내: 
    고구마를 심을 가장 좋은 시기는 지역에 따라 다릅니다. 
    일반적으로 남부지방에서는 5월 상순에, 중북부지방에서는 5월 중순에 심는 것이 좋습니다. 
    이는 고구마의 수량을 최대로 얻을 수 있는 시기로, 비닐멀칭을 하지 않는 경우의 일반적인 권장 시기입니다. 
    또한, 아주심기 한계기는 남부지방에서는 7월 상순까지, 중북부지방에서는 6월 말까지로, 이 기간 이후에 심게 되면 수량 감소가 발생할 수 있습니다. 
    따라서 가능한 한 이 시기 내에 심는 것이 수량을 극대화하는 데 도움이 됩니다.
    """
        },
        {
            "question": "얼갈이배추가 발아 초기는 괜찮다가 크면서 잎이 오그라들고 시들어 죽기도 하구요. 주변으로 번집니다. 같은 밭에서 날이 더워지면 발생합니다.",
            "answer": """
    ### 1단계: 질문 의도 분석
    - 질문의 핵심은 얼갈이배추가 발아 후 초기에는 정상적으로 성장하다가, 크면서 잎이 오그라들고 시들어 죽는 현상에 대한 것입니다.
    - 이는 병해충 또는 생리장해에 관한 질문으로 분류됩니다.
    - 질문에서 얼갈이배추라는 작물이 명확하게 언급되었습니다.
    - 시스템에서 제공하는 작물 리스트에 배추가 포함되어 있으므로, 얼갈이배추에 대한 정보 제공이 가능합니다.

    ### 2단계: 정보 탐색 및 근거 확인
    - 참고 문서에 따르면, 얼갈이배추의 잎이 오그라드는 증상은 시들음병(위황병)으로 생각됩니다.
    - 이 병은 같은 작물을 계속해서 이어짓기 할 경우 발생할 수 있으며, 토양 관리가 중요하다고 언급되어 있습니다.

    ### 3단계: 논리적 정리 및 응답 생성
    🩺진단소견: 
    얼갈이배추의 잎이 오그라드는 증상은 시들음병(위황병)으로 인한 것으로 추정됩니다. 
    이 병은 특히 같은 작물을 연속해서 재배하는 이어짓기에서 자주 발생합니다. 
    또한, 증상이 더워질 때 주로 발생한다고 하셨는데, 이는 고온이 병의 발생을 촉진할 수 있음을 시사합니다.

    🌿방제법:
    1. **돌려짓기 실시**: 십자화과가 아닌 다른 작물로 돌려짓기를 하여 토양의 병원균 농도를 낮추는 것이 중요합니다.
    2. **토양 pH 조절**: 토양의 산도를 pH 6.5~7.0 정도로 유지합니다.
    3. **토양 관리**: 토양 중 미세동물에 의해 뿌리에 상처가 나지 않도록 주의하고, 병든 포기는 일찍 제거하여 병의 확산을 막습니다.
    4. **잔재물 제거**: 수확 후 병든 잔재물을 포장에서 완전히 수거하여 제거합니다.
    5. **토양소독**: 가능한 경우 토양소독을 고려할 수 있으나, 돌려짓기와 토양 관리가 더 효과적인 방법입니다.

    이러한 조치들을 통해 얼갈이배추의 시들음병을 관리하고 예방할 수 있습니다.
    """
        },
    ]

# LLM에게 가이드를 주는 Prefix
prefix = """당신은 농업 전문가입니다.   

    ### 추론 단계:
    1단계 질문 의도 분석:  
        - 질문의 의도와 핵심이 무엇인지 알아냅니다.
        - 질문의 유형을 (병해충, 생리장해, 일반 재배 정보, 기타)로 구분합니다.
        - 질문에서 **어느 작물에 대한 것인지 명확하지 않을 경우**, 추가적인 정보를 요청합니다.  
            **예시:**  
            - 질문: "잎에 갈색 반점이 생기고 말라가요."  
                → "어떤 작물의 잎에 반점이 생기고 있나요? 예를 들어, 감자, 고구마, 배추 중 어느 것인지 알려주시면 더 정확한 진단이 가능합니다."  

        - 만약 **시스템에서 제공하지 않는 작물일 경우**:  
            - "저는 [상추], [배추], [깻잎], [시금치], [감자], [고구마], [마늘], [양파], [토마토], [고추]에 대한 정보만 제공하고 있습니다.  
            - 궁금하신 내용은 관련 전문 기관이나 다른 자료를 참고해 주세요."  
            - 이 경우, 질문의 유형은 **시스템이 제공하는 주제와 무관한 질문**입니다.


    2단계 정보 탐색 및 근거 확인:
        - 문서에서 필요한 정보를 찾습니다.
        - 만약 정보가 없다면, 해당 문서에서 찾을 수 없다고 답변합니다.
        - 정보가 있다면 그 근거를 설명합니다.
        

    3단계 논리적 정리 및 응답 생성:
        - 찾은 정보와 근거를 바탕으로 질문 유형에 맞게 답안을 작성합니다.
        - 질문 유형에 따라 아래와 같은 형식을 따릅니다:
            ● 병해충 또는 생리장해에 관한 질문일 경우:
            - 🩺진단소견: 문제의 원인을 분석하고 진단 내용을 서술  
            - 🌿방제법: 문서 기반으로 적절한 방제 방법을 설명

            ● 일반적인 농작물 재배법이나 정보 요청일 경우:
            - 📢 안내: 정확한 재배법 또는 정보 안내

            ● 시스템이 제공하는 주제와 무관한 질문일 경우:
            - 🙏 안내드립니다: 본 시스템이 제공하지 않는 범위임을 공손하게 설명


※ 모든 단계는 문서 기반이어야 하며, 추측은 지양해야 합니다.
※ 자연스럽고 논리적으로 서술하세요.
※ 최종 출력은 3단계만 응답으로 나옵니다.
"""

# CoT(Chain-of-Thought) 기반 프롬프트 체인을 구성. llm_model_name: 사용할 LLM 모델 이름
def build_user_query_prompt_chain(llm_model_name: str = "gpt-4-turbo"):
    if not OPENAI_API_KEY:
        raise ValueError("OpenAI API 키가 설정되지 않았습니다. CoT 체인을 빌드할 수 없습니다.")

    llm = ChatOpenAI(
        temperature=0,
        model_name=llm_model_name,
        openai_api_key=OPENAI_API_KEY,
        max_tokens = 1024,
        callbacks=CALLBACKS_COT # LangSmith 콜백 전달
    )

    # 의미 기반 예시 선택기
    example_selector = SemanticSimilarityExampleSelector.from_examples(
        examples, # 선택 가능한 예시 목록
        OpenAIEmbeddings(openai_api_key=OPENAI_API_KEY), # 임베딩 클래스 (의미적 유사성 측정)
        FAISS, # 벡터저장소 클래스 (유사성 검색)
        k=1 # 생성할 예시의 수
    )

    # Few-shot PromptTemplate 구성
    prompt = FewShotPromptTemplate(
        prefix=prefix,
        example_selector=example_selector,
        example_prompt=PromptTemplate.from_template(
            "Question:\n{question}\nAnswer:\n{answer}"
        ),# 예시 프롬프트 템플릿
        suffix="Question:\n{question}\nAnswer:",
        input_variables=["question"],
    )

    # 체인 반환
    return prompt | llm

# 체인 실행 결과를 스트리밍하고, content만 추출하여 반환
def stream_final_answer_only(chain, question: str):
    try:
        for chunk in chain.stream({"question": question}):
            content_to_yield = ""
            if hasattr(chunk, "content"): # AIMessageChunk 등
                content_to_yield = chunk.content
            elif isinstance(chunk, str): # StrOutputParser 사용 시
                content_to_yield = chunk
            else: # 기타 경우 문자열로 변환
                content_to_yield = str(chunk)
            yield content_to_yield
    except Exception as e:
        yield f"\n\n[스트리밍 중 오류 발생: {e}]"